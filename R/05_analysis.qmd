---
title: "04_analysis"
format:
  html:
    embed-resources: true
knitr:
  opts_chunk:
    dev: "ragg_png"
    fig.path: "../results/"
editor: visual
---

# Analysis of gene expressions

To identify genes that might have an impact on type 2 diabetes development, we want to select genes with large expression differences between type 2 diabetes (T2D) and control groups.

## Load libraries and data

```{r}
#| message: false
#| label: setup
library("tidyverse")
library("matrixStats")
```

## Load data

```{r}
#| label: load data
df_T2D <- read.csv("../data/03_T2D_data.csv")
df_control <- read.csv("../data/03_control_data.csv")
```

### Gene expression differences

We will for each data set use the median expression of the samples of each gene and save them:

```{r}
# For type 2 diabetes:
df_T2D_medians <- df_T2D |>
  mutate(median_expression_T2D = rowMedians(as.matrix(across(starts_with("GSM"))))) |>
  select(IDENTIFIER, median_expression_T2D)

# For control group:
df_control_medians <- df_control |>
  mutate(median_expression_control = rowMedians(as.matrix(across(starts_with("GSM"))))) |>
  select(IDENTIFIER, median_expression_control)
```

Now we will merge the T2D and control medians that we created above, by identifier with inner join. We also calculate the difference of the expression levels and the absolute difference.

```{r}
expression_comparison <- df_T2D_medians |>
  inner_join(df_control_medians, by = "IDENTIFIER") |>
  mutate(
    median_difference = median_expression_T2D - median_expression_control, # difference medians
    abs_difference = abs(median_difference) # absolute difference
  ) |>
  arrange(desc(abs_difference)) # arrange by the largest absolute difference first

top_diff_genes <- head(expression_comparison, 30)

print(top_diff_genes)
```

## Save the top 30 genes for further analysis

```{r}
top_diff_genes |> 
  select(IDENTIFIER) |> 
  write.csv("../data/05_selected_genes_median.csv")
```

## Visualization of top gene differences

```{r}
#| label: 05_Expression_median_plot
# options(bitmapType='cairo')
# Prepare data for plotting
top_30_plot <- head(expression_comparison, 30) |>
  mutate(
    direction = ifelse(median_difference > 0, "Up in T2D", "Down in T2D"),
    gene_label = IDENTIFIER
  )

# bar plot
ggplot(top_30_plot, aes(x = reorder(gene_label, median_difference), 
                       y = median_difference, 
                       fill = direction)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 30 Genes with Largest Expression Differences (Median)",
    subtitle = "T2D vs Control Groups",
    x = "Gene Identifier",
    y = "Expression Difference (T2D - Control)",
    fill = "Expression Direction"
  ) +
  scale_fill_manual(values = c("Up in T2D" = "red", "Down in T2D" = "blue")) +
  theme_minimal()
```


### Expression Distribution of Top 10 Genes

To visualize how individual sample expression levels vary within each group, we create boxplots for the top 10 genes with the largest median differences. 

```{r}
#| label: 05_Expression_median_boxplot
# Show actual expression values for top 10 genes
top_10_genes <- head(expression_comparison, 10)$IDENTIFIER

# Create the combined data properly for boxplot
plot_data <- bind_rows(
  df_T2D |> 
    filter(IDENTIFIER %in% top_10_genes) |>
    select(IDENTIFIER, starts_with("GSM")) |>
    pivot_longer(cols = -IDENTIFIER, names_to = "sample", values_to = "expression") |>
    mutate(group = "T2D"),
  
  df_control |> 
    filter(IDENTIFIER %in% top_10_genes) |>
    select(IDENTIFIER, starts_with("GSM")) |>
    pivot_longer(cols = -IDENTIFIER, names_to = "sample", values_to = "expression") |>
    mutate(group = "Control")
)

# Create the boxplot
ggplot(plot_data, aes(x = IDENTIFIER, y = expression, fill = group)) +
  geom_boxplot() +
  labs(title = "Expression Distribution of Top 10 Differential Genes",
       x = "Gene", y = "Expression Level") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate gene names if they overlap
```


