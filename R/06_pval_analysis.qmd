---
title: "06_pval_analysis"
format:
  html:
    embed-resources: true
knitr:
  opts_chunk:
    dev: "svg"
    fig.path: "../results/"
editor: visual
---

## Load libraries and data

```{r}
#| label: setup
#| message: false
library("tidyverse")
library("broom")
```

## Load data

For this analysis we wish to load the transposed dataset created back in 02_clean_data.

```{r}
#| label: load_data
transposed_expression_data <- read.table("../data/02_transposed_data.csv")
```

# Calculating p-values and pivoting longer

First and foremost we need to get our dataset into proper shape for our analysis and for easier calculation of p-values. We will be using methodology very alike to that seen in Lab 06.

Step one is using pivot_longer to "fold out" our dataset into one long list and factorise it based on the disease state (either T2D or non-diabetic) as well as transforming our log2 values into numbers.

```{r}
#| label: pivot_longer
expression_data_long <- transposed_expression_data |>
  pivot_longer(
    cols = -starts_with("disease.state"),
    names_to = "gene",
    values_to = "log_fold_change"
  ) |>
  mutate(disease.state = factor(disease.state)) |>
  mutate(log_fold_change = as.numeric(log_fold_change))
```

Now that we pivoted the table to one long dataframe we can move on to the next step and nest the values on a per gene basis.

```{r}
expression_data_nested <- expression_data_long |>
  group_by(gene) |>
  nest() |>
  ungroup()
```

With nesting done it is at long last time to calculate some p-values.

```{r}
expression_data_nested_with_pvals <- expression_data_nested |>
  group_by(gene) |>
  mutate(model_object = map(.x = data,
                            .f = ~tidy(lm(formula = log_fold_change ~ disease.state,
                                     data = .x),
                                     conf.int = TRUE,
                                     conf.level = 0.95))) |>
  ungroup()
```

```{r}
t2d_estimates <- expression_data_nested_with_pvals |>
  unnest(model_object)
```

```{r}
t2d_estimates <- t2d_estimates |>
  subset(term == "disease.stateT2D") |>
  select(gene, p.value, estimate, conf.low, conf.high) |>
  ungroup()
```

```{r}
t2d_estimates <- t2d_estimates |>
  mutate(is.significant = ifelse(p.value < 0.05, "yes", "no"))
```

```{r}
t2d_estimates |>
  group_by(is.significant) |>
  summarise(count = n())
```

```{r}
t2d_estimates_selected <- t2d_estimates |>
  arrange(p.value) |>
  slice_head(n = 25)
```

```{r}
t2d_estimates_selected |>
  select(gene) |>
  write.csv("../data/06_selected_genes_pvalue.csv")
```

```{r}
t2d_estimates_selected |>
  subset(is.significant == "yes") |>
  ggplot(
    mapping = aes(x = estimate,
                  y = fct_reorder(gene,estimate))
  )+
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, 
                     xmax = conf.high),
                 height = 0.5) +
  geom_vline(xintercept = 0,
             linetype = "solid",
             color = "black") +
  labs(title = "Header",
       x = "Estimates with 95%CI",
       y = "") +
  theme_minimal()
```
