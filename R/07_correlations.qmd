---
title: "07 Correlations"
format:
  html:
    embed-resources: true
knitr:
  opts_chunk:
    dev: "ragg_png"
    fig.path: "../results/"
editor: visual
---

## Load Libraries

```{r}
#| label: setup
#| message: false
library("tidyverse")
```

## Load Data

Selected genes from the method using median and selected genes from the method using linear regression and the p-values.

```{r}
#| label: read files
median_genes <- read.csv("../data/05_selected_genes_median.csv")
pval_genes <- read.csv("../data/06_selected_genes_pvalue.csv")
df_T2D <- read.csv("../data/03_T2D_data.csv")
df_non_T2D <- read.csv("../data/03_none_T2D_data.csv")
```

Using inner join two find the unique values within the two gene-data sets and save it as a vector

```{r}
#| label: Join sets of genes
median_genes <- median_genes |> 
  select(-X)
pval_genes <- pval_genes |> 
  select(-X)
selected_genes <- median_genes |> 
  inner_join(pval_genes, by = c("IDENTIFIER" = "gene"))

selected_genes_vec <- selected_genes |> 
  pull(IDENTIFIER)
```

Create heatmap of selected genes

```{r}
#| label: heatmap
# Use df_T2D for correlation
cor_data_top5 <- df_T2D |>
  filter(IDENTIFIER %in% selected_genes_vec) |>
  select(IDENTIFIER, starts_with("GSM")) |>
  column_to_rownames("IDENTIFIER") |>
  t() |>
  cor(use = "pairwise.complete.obs")

# Convert to tidy format using tidyverse (no melt)
melted_cor_top5 <- cor_data_top5 |>
  as.data.frame() |>
  rownames_to_column("Var1") |>
  pivot_longer(cols = -Var1, names_to = "Var2", values_to = "value")

# Create the heatmap (rest of your code stays the same)
ggplot(melted_cor_top5, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limits = c(-1, 1),
                       name = "Correlation") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 3) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Top 5 Diabetes-Related Genes: Co-expression Patterns",
       #subtitle = paste("Red = higher in T2D (", 
       #                sum(top_5_plot_data$direction == "Up in T2D"), " genes) | ",
       #                "Blue = lower in T2D (", 
       #                sum(top_5_plot_data$direction == "Down in T2D"), " genes)",
       #                sep = ""),
       x = "", y = "") +
  coord_fixed()
```
